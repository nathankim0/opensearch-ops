---
name: investigate
description: "이슈 설명과 발생 시간대를 입력하면 OpenSearch 로그 조사 + 백엔드 코드 분석을 자동으로 수행합니다. 예: '결제 실패가 2월 25일 5시~7시 쯤 발생'"
argument-hint: "[이슈 설명] [날짜] [시간대]"
---

# 장애 조사 스킬

사용자가 제공한 이슈 설명과 시간대를 기반으로 **OpenSearch 로그 조사 → 코드 분석 → 원인 파악**까지 자동으로 수행합니다.

## 입력

$ARGUMENTS

## 조사 절차

아래 절차를 **순서대로** 수행하세요.

### 1단계: 입력 파싱

사용자 입력에서 다음을 추출합니다:
- **이슈 키워드**: 에러명, 기능명, 서비스명 등
- **발생 날짜**: YYYY-MM-DD 형식으로 변환
- **발생 시간대** (selection): 이슈가 발생한 시간 범위 (ISO 8601)
- **기준 시간대** (baseline): 이슈 발생 직전 동일 길이의 정상 시간대

예시: "결제 실패가 2월 25일 5시~7시" →
- selection: `2025-02-25T05:00:00` ~ `2025-02-25T07:00:00`
- baseline: `2025-02-25T03:00:00` ~ `2025-02-25T05:00:00`

### 2단계: OpenSearch 인덱스 확인

**ListIndexTool**을 사용하여 사용 가능한 인덱스를 확인합니다.
- 로그 인덱스 패턴 파악 (예: `app-logs-*`, `nginx-*`, `backend-*`)
- 이슈와 관련된 인덱스를 선별

### 3단계: 로그 패턴 분석 (이상 탐지)

**LogPatternAnalysisTool**을 사용하여 baseline과 selection 기간을 비교합니다:
- 이슈 시간대에만 새로 등장한 에러 패턴
- 급증한 로그 패턴
- trace ID 기반 시퀀스 이상

### 4단계: 상세 로그 검색

**SearchIndexTool**로 핵심 로그를 조회합니다:

```json
{
  "query": {
    "bool": {
      "must": [
        { "range": { "@timestamp": { "gte": "<selection_start>", "lte": "<selection_end>" } } }
      ],
      "should": [
        { "match": { "level": "ERROR" } },
        { "match": { "level": "WARN" } },
        { "match_phrase": { "message": "<이슈 키워드>" } }
      ],
      "minimum_should_match": 1
    }
  },
  "sort": [{ "@timestamp": "asc" }],
  "size": 50
}
```

필요 시 추가로:
- 특정 서비스/호스트별 필터링
- 스택트레이스 포함 로그 검색
- 연관 trace ID 추적

### 5단계: 데이터 분포 분석

**DataDistributionTool**로 이슈 전후 데이터 분포를 비교합니다:
- 에러 코드별 분포 변화
- 응답 시간 분포 변화
- 요청량 변화 패턴

### 6단계: 백엔드 코드 분석

로그에서 발견된 정보를 기반으로 프로젝트 코드를 분석합니다:
- **에러 메시지** → Grep으로 코드 내 해당 메시지 발생 위치 검색
- **스택트레이스의 파일명/함수명** → 해당 코드 파일 읽기 및 분석
- **API 엔드포인트** → 라우팅 코드에서 해당 핸들러 로직 검토
- **DB 쿼리/외부 API 호출** → 타임아웃, 커넥션 풀, 재시도 로직 점검

### 7단계: 결과 보고

아래 형식으로 조사 결과를 정리합니다:

```
## 장애 조사 보고서

### 요약
- 이슈: [한 줄 요약]
- 영향 시간: YYYY-MM-DD HH:MM ~ HH:MM (총 N시간)
- 영향 범위: [영향 받은 서비스/기능]

### 타임라인
| 시각 | 이벤트 |
|------|--------|
| HH:MM | 최초 에러 발생 |
| HH:MM | 에러 급증 시작 |
| HH:MM | 정상화 |

### 근본 원인
[코드/인프라/외부 의존성 등 구체적 원인]

### 관련 코드
- `파일경로:라인번호` - [설명]

### 재발 방지 제안
1. [단기 조치]
2. [장기 개선]
```

## 주의사항

- 타임존은 기본 UTC, 사용자가 KST를 언급하면 +09:00 적용
- 로그 인덱스 패턴이 불명확하면 먼저 ListIndexTool로 확인 후 진행
- 로그 양이 너무 많으면 size를 줄이고 집계(aggregation) 쿼리 활용
- 코드 분석 시 최근 커밋 히스토리도 확인하여 변경사항과 이슈 연관성 파악
